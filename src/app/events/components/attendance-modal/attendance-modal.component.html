<ion-header>
  <ion-toolbar class="attendance-header">
    <ion-buttons slot="start">
      <ion-button fill="clear" (click)="dismiss()" class="close-btn">
        <ion-icon name="close"></ion-icon>
      </ion-button>
    </ion-buttons>
    
    <ion-title class="header-title">
      <div class="title-container">
        <div class="title-icon">
          <ion-icon name="people"></ion-icon>
        </div>
        <div class="title-text">
          <span class="main-title">Take Attendance</span>
          <span class="sub-title">{{ event?.title || 'Event' }}</span>
        </div>
      </div>
    </ion-title>
    
    <ion-buttons slot="end">
      <ion-button 
        fill="solid" 
        (click)="saveAttendance()"
        class="save-button haptic-feedback"
        [disabled]="isSaving">
        <div class="save-btn-content">
          <ion-icon name="checkmark" slot="start" *ngIf="!isSaving"></ion-icon>
          <ion-spinner name="crescent" *ngIf="isSaving"></ion-spinner>
          <span>{{ isSaving ? 'Saving...' : 'Save' }}</span>
        </div>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
  
  <!-- Progress indicator -->
  <div class="header-progress">
    <div class="progress-stats">
      <div class="stat-chip present">
        <ion-icon name="checkmark-circle"></ion-icon>
        <span>{{ presentCount + lateCount }}</span>
      </div>
      <div class="stat-chip total">
        <ion-icon name="people"></ion-icon>
        <span>{{ totalMembers }}</span>
      </div>
      <div class="completion-indicator">
        <span class="completion-text">{{ getAttendancePercentage() }}% Complete</span>
        <div class="completion-bar">
          <div class="completion-fill" [style.width.%]="getAttendancePercentage()"></div>
        </div>
      </div>
    </div>
  </div>
</ion-header>

<ion-content class="attendance-content">
  <!-- Event Header -->
  <div class="event-header">
    <div class="event-info">
      <h2>{{ event.title }}</h2>
      <p class="event-details">
        <ion-icon name="calendar"></ion-icon>
        {{ formatDate(event.date) }} at {{ formatTime(event.time) }}
      </p>
      <p class="event-location">
        <ion-icon name="location"></ion-icon>
        {{ event.location }}
      </p>
    </div>
  </div>

  <!-- Attendance Statistics -->
  <div class="attendance-stats">
    <div class="stats-header">
      <h3>Attendance Overview</h3>
      <div class="attendance-percentage">
        <span class="percentage-value">{{ getAttendancePercentage() }}%</span>
        <span class="percentage-label">Present</span>
      </div>
    </div>
    
    <div class="stats-grid">
      <div class="stat-item present">
        <ion-icon name="checkmark-circle"></ion-icon>
        <span class="stat-number">{{ presentCount }}</span>
        <span class="stat-label">Present</span>
      </div>
      <div class="stat-item late">
        <ion-icon name="time"></ion-icon>
        <span class="stat-number">{{ lateCount }}</span>
        <span class="stat-label">Late</span>
      </div>
      <div class="stat-item excused">
        <ion-icon name="information-circle"></ion-icon>
        <span class="stat-number">{{ excusedCount }}</span>
        <span class="stat-label">Excused</span>
      </div>
      <div class="stat-item absent">
        <ion-icon name="close-circle"></ion-icon>
        <span class="stat-number">{{ absentCount }}</span>
        <span class="stat-label">Absent</span>
      </div>
    </div>

    <ion-progress-bar 
      [value]="getAttendancePercentage() / 100"
      [color]="getAttendancePercentage() > 75 ? 'success' : getAttendancePercentage() > 50 ? 'warning' : 'danger'">
    </ion-progress-bar>
  </div>

  <!-- Enhanced Floating Action Menu -->
  <ion-fab vertical="bottom" horizontal="end" slot="fixed" class="enhanced-fab">
    <ion-fab-button 
      color="primary" 
      [class.rotated]="fabMenuOpen" 
      (click)="toggleFabMenu()"
      title="Quick Actions"
      class="main-fab">
      <div class="fab-icon-container">
        <ion-icon name="add" [class.rotated]="fabMenuOpen" class="add-icon"></ion-icon>
        <ion-icon name="close" [class.visible]="fabMenuOpen" class="close-icon"></ion-icon>
      </div>
    </ion-fab-button>

    <ion-fab-list side="top" [class.show]="fabMenuOpen">
      <!-- Mark All Present -->
      <ion-fab-button 
        color="success" 
        (click)="openMarkAllPresentModal(); closeFabMenu()"
        title="Mark All Present"
        class="fab-action mark-all">
        <ion-icon name="checkmark-done"></ion-icon>
        <div class="fab-tooltip">
          <span>Mark All Present</span>
        </div>
      </ion-fab-button>

      <!-- Quick Check-in -->
      <ion-fab-button 
        color="warning" 
        (click)="openQuickCheckInModal(); closeFabMenu()"
        title="Quick Check-in"
        class="fab-action quick-checkin">
        <ion-icon name="flash"></ion-icon>
        <div class="fab-tooltip">
          <span>Quick Check-in</span>
        </div>
      </ion-fab-button>

      <!-- Add Guest -->
      <ion-fab-button 
        color="secondary" 
        (click)="openAddGuestModal(); closeFabMenu()"
        title="Add Guest"
        class="fab-action add-guest">
        <ion-icon name="person-add"></ion-icon>
        <div class="fab-tooltip">
          <span>Add New Guest</span>
        </div>
      </ion-fab-button>
    </ion-fab-list>

    <!-- Enhanced Backdrop -->
    <div class="fab-backdrop enhanced-backdrop" 
         [class.show]="fabMenuOpen" 
         (click)="closeFabMenu()">
      <div class="backdrop-content">
        <div class="backdrop-text">Quick Actions</div>
        <div class="backdrop-hint">Tap anywhere to close</div>
      </div>
    </div>
  </ion-fab>

  <!-- Search Bar -->
  <div class="search-section">
    <ion-searchbar
      [formControl]="searchControl"
      placeholder="Search members..."
      showClearButton="focus"
      class="members-searchbar">
    </ion-searchbar>
  </div>

  <!-- New Guests Section -->
  <div class="new-guests-section" *ngIf="getNewGuests().length > 0">
    <div class="section-header">
      <h4>New Guests Today</h4>
      <ion-badge color="secondary">{{ getNewGuests().length }}</ion-badge>
    </div>
    <div class="guests-chips">
      <ion-chip 
        *ngFor="let guest of getNewGuests()" 
        color="secondary" 
        outline="true"
        (click)="scrollToMember(guest.id)">
        <ion-icon name="person-add"></ion-icon>
        <ion-label>{{ guest.firstName }} {{ guest.lastName }}</ion-label>
      </ion-chip>
    </div>
  </div>

  <!-- Members List -->
  <div class="members-list">
    <div *ngFor="let member of filteredMembers; trackBy: trackByMemberId" 
         class="member-item" 
         [attr.data-member-id]="member.id"
         [class.new-guest]="member.id.startsWith('guest_')"
         (click)="triggerRippleEffect($event, member)">
      <div class="member-avatar">
        <div class="avatar-circle" [class]="member.membershipStatus">
          <span class="avatar-initials">{{ getMemberInitials(member) }}</span>
        </div>
        <div class="membership-indicator" [class]="member.membershipStatus"></div>
        <div class="new-guest-badge" *ngIf="member.id.startsWith('guest_')">
          <ion-icon name="sparkles"></ion-icon>
        </div>
      </div>

      <div class="member-info">
        <h4 class="member-name">{{ member.firstName }} {{ member.lastName }}</h4>
        <p class="member-email" *ngIf="member.email">{{ member.email }}</p>
        <p class="member-status">
          <span class="status-badge" [class]="member.membershipStatus">
            {{ member.membershipStatus | titlecase }}
          </span>
          <span class="last-attended" *ngIf="member.lastAttended">
            Last: {{ formatDate(member.lastAttended) }}
          </span>
        </p>
      </div>

      <div class="attendance-controls">
        <!-- Current Status Display -->
        <div class="current-status">
          <ion-badge 
            [color]="getAttendanceStatusColor(attendanceRecords.get(member.id)?.status || 'absent')"
            class="status-badge">
            <ion-icon [name]="getAttendanceStatusIcon(attendanceRecords.get(member.id)?.status || 'absent')"></ion-icon>
            {{ (attendanceRecords.get(member.id)?.status || 'absent') | titlecase }}
          </ion-badge>
        </div>

        <!-- Attendance Action Button -->
        <div class="attendance-actions">
          <ion-button 
            fill="clear" 
            size="default" 
            color="primary"
            (click)="presentAttendanceOptions(member)"
            class="haptic-feedback">
            <ion-icon name="ellipsis-horizontal" slot="icon-only"></ion-icon>
          </ion-button>
        </div>

        <!-- Notes Button (removed since it's now in the action sheet) -->
      </div>
    </div>

    <!-- Empty State -->
    <div *ngIf="filteredMembers.length === 0" class="empty-state">
      <ion-icon name="people-outline" color="medium"></ion-icon>
      <h3>No members found</h3>
      <p>Try adjusting your search terms</p>
    </div>
  </div>

  <!-- Modern Add Guest Modal -->
  <div class="modern-modal-overlay" [class.show]="showAddGuestModal" (click)="closeAddGuestModal()">
    <div class="modern-modal add-guest-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <div class="modal-icon">
          <ion-icon name="person-add" color="secondary"></ion-icon>
        </div>
        <h2>Add New Guest</h2>
        <p>Welcome someone new to the community</p>
        <ion-button fill="clear" class="close-button" (click)="closeAddGuestModal()">
          <ion-icon name="close"></ion-icon>
        </ion-button>
      </div>
      
      <div class="modal-content">
        <form [formGroup]="addGuestForm" (ngSubmit)="submitNewGuest()">
          <div class="form-group">
            <label for="firstName">First Name *</label>
            <ion-input
              id="firstName"
              formControlName="firstName"
              placeholder="Enter first name"
              fill="outline"
              [class.error]="addGuestForm.get('firstName')?.invalid && addGuestForm.get('firstName')?.touched">
            </ion-input>
            <div class="error-message" *ngIf="addGuestForm.get('firstName')?.invalid && addGuestForm.get('firstName')?.touched">
              First name is required
            </div>
          </div>
          
          <div class="form-group">
            <label for="lastName">Last Name *</label>
            <ion-input
              id="lastName"
              formControlName="lastName"
              placeholder="Enter last name"
              fill="outline"
              [class.error]="addGuestForm.get('lastName')?.invalid && addGuestForm.get('lastName')?.touched">
            </ion-input>
            <div class="error-message" *ngIf="addGuestForm.get('lastName')?.invalid && addGuestForm.get('lastName')?.touched">
              Last name is required
            </div>
          </div>
          
          <div class="form-group">
            <label for="email">Email Address</label>
            <ion-input
              id="email"
              formControlName="email"
              type="email"
              placeholder="Enter email (optional)"
              fill="outline">
            </ion-input>
          </div>
          
          <div class="form-group">
            <label for="phone">Phone Number</label>
            <ion-input
              id="phone"
              formControlName="phone"
              type="tel"
              placeholder="Enter phone (optional)"
              fill="outline">
            </ion-input>
          </div>
          
          <div class="form-actions">
            <ion-button 
              fill="clear" 
              color="medium" 
              (click)="closeAddGuestModal()"
              class="cancel-btn">
              Cancel
            </ion-button>
            <ion-button 
              type="submit" 
              [disabled]="addGuestForm.invalid"
              class="submit-btn">
              <ion-icon name="checkmark" slot="start"></ion-icon>
              Add & Check In
            </ion-button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Modern Quick Check-in Modal -->
  <div class="modern-modal-overlay" [class.show]="showQuickCheckInModal" (click)="closeQuickCheckInModal()">
    <div class="modern-modal quick-checkin-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <div class="modal-icon">
          <ion-icon name="flash" color="warning"></ion-icon>
        </div>
        <h2>Quick Check-in</h2>
        <p>Find and check in a member quickly</p>
        <ion-button fill="clear" class="close-button" (click)="closeQuickCheckInModal()">
          <ion-icon name="close"></ion-icon>
        </ion-button>
      </div>
      
      <div class="modal-content">
        <div class="search-container">
          <ion-searchbar
            [(ngModel)]="quickCheckInSearch"
            (ionInput)="filterMembersForQuickCheckIn()"
            placeholder="Search by name or email..."
            show-clear-button="focus"
            class="quick-search">
          </ion-searchbar>
        </div>
        
        <div class="quick-results" *ngIf="quickCheckInResults.length > 0">
          <div class="results-header">
            <h4>Select Member to Check In</h4>
          </div>
          <div class="member-quick-list">
            <div 
              *ngFor="let member of quickCheckInResults" 
              class="quick-member-item"
              (click)="quickCheckInMember(member)">
              <div class="quick-avatar">
                <div class="avatar-circle" [class]="member.membershipStatus">
                  <span>{{ getMemberInitials(member) }}</span>
                </div>
              </div>
              <div class="quick-info">
                <h5>{{ member.firstName }} {{ member.lastName }}</h5>
                <p>{{ member.email }}</p>
              </div>
              <div class="quick-action">
                <ion-icon name="checkmark-circle" color="success"></ion-icon>
              </div>
            </div>
          </div>
        </div>
        
        <div class="no-results" *ngIf="quickCheckInSearch && quickCheckInResults.length === 0">
          <ion-icon name="search" color="medium"></ion-icon>
          <p>No members found matching "{{ quickCheckInSearch }}"</p>
          <ion-button 
            fill="outline" 
            color="secondary" 
            size="small"
            (click)="addNewGuest(quickCheckInSearch); closeQuickCheckInModal()"
            class="add-guest-suggestion">
            <ion-icon name="person-add" slot="start"></ion-icon>
            Add as New Guest
          </ion-button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modern Note Modal -->
  <div class="modern-modal-overlay" [class.show]="showNoteModal" (click)="closeNoteModal()">
    <div class="modern-modal note-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <div class="modal-icon">
          <ion-icon name="create" color="primary"></ion-icon>
        </div>
        <h2>{{ noteModalData.isEdit ? 'Edit Note' : 'Add Note' }}</h2>
        <p>{{ noteModalData.memberName }}</p>
        <ion-button fill="clear" class="close-button" (click)="closeNoteModal()">
          <ion-icon name="close"></ion-icon>
        </ion-button>
      </div>
      
      <div class="modal-content">
        <form [formGroup]="noteForm" (ngSubmit)="submitNote()">
          <div class="form-group">
            <label for="note">Attendance Note</label>
            <ion-textarea
              id="note"
              formControlName="note"
              placeholder="Add any notes about this member's attendance..."
              rows="4"
              fill="outline"
              maxlength="500"
              counter="true">
            </ion-textarea>
            <div class="character-count">
              {{ noteForm.get('note')?.value?.length || 0 }}/500
            </div>
          </div>
          
          <div class="form-actions">
            <ion-button 
              fill="clear" 
              color="medium" 
              (click)="closeNoteModal()"
              class="cancel-btn">
              Cancel
            </ion-button>
            <ion-button 
              fill="clear" 
              color="danger" 
              *ngIf="noteModalData.isEdit && noteForm.get('note')?.value"
              (click)="removeNote()"
              class="remove-btn">
              <ion-icon name="trash" slot="start"></ion-icon>
              Remove
            </ion-button>
            <ion-button 
              type="submit" 
              class="submit-btn">
              <ion-icon name="checkmark" slot="start"></ion-icon>
              {{ noteModalData.isEdit ? 'Update' : 'Save' }}
            </ion-button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Modern Confirmation Modal for Mark All Present -->
  <div class="modern-modal-overlay" [class.show]="showMarkAllPresentModal" (click)="closeMarkAllPresentModal()">
    <div class="modern-modal confirmation-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <div class="modal-icon">
          <ion-icon name="checkmark-done" color="success"></ion-icon>
        </div>
        <h2>Mark All Present</h2>
        <p>This will mark all {{ totalMembers }} members as present</p>
        <ion-button fill="clear" class="close-button" (click)="closeMarkAllPresentModal()">
          <ion-icon name="close"></ion-icon>
        </ion-button>
      </div>
      
      <div class="modal-content">
        <div class="confirmation-stats">
          <div class="stat-preview">
            <div class="stat-icon">
              <ion-icon name="people" color="primary"></ion-icon>
            </div>
            <div class="stat-info">
              <h4>{{ totalMembers }} Members</h4>
              <p>Will be marked as present</p>
            </div>
          </div>
          
          <div class="stat-preview">
            <div class="stat-icon">
              <ion-icon name="trending-up" color="success"></ion-icon>
            </div>
            <div class="stat-info">
              <h4>100% Attendance</h4>
              <p>New attendance rate</p>
            </div>
          </div>
        </div>
        
        <div class="warning-message">
          <ion-icon name="information-circle" color="warning"></ion-icon>
          <p>This action will override any existing attendance status for all members.</p>
        </div>
        
        <div class="form-actions">
          <ion-button 
            fill="clear" 
            color="medium" 
            (click)="closeMarkAllPresentModal()"
            class="cancel-btn">
            Cancel
          </ion-button>
          <ion-button 
            (click)="confirmMarkAllPresent()"
            class="submit-btn">
            <ion-icon name="checkmark-done" slot="start"></ion-icon>
            Mark All Present
          </ion-button>
        </div>
      </div>
    </div>
  </div>
</ion-content>
