<ion-header class="modal-header">
  <ion-toolbar>
    <ion-title>{{ editingWorkflow ? 'Edit' : 'Create' }} Workflow</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="dismiss()" class="close-button">
        <ion-icon name="close" slot="icon-only"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<!-- Step Indicator -->
<div class="step-indicator">
  <div class="step-progress">
    <div class="step-line"></div>
    <div class="step-dot" 
         *ngFor="let step of [1,2,3,4]; let i = index"
         [class.active]="currentStep === step"
         [class.completed]="currentStep > step">
      <span>{{ step }}</span>
    </div>
  </div>
  <div class="step-title">
    <h3>Step {{ currentStep }} of {{ totalSteps }}</h3>
    <p>{{ getStepTitle() }}</p>
  </div>
</div>

<ion-content class="wizard-content">
  <!-- Step 1: Name and Trigger Type -->
  <div class="wizard-step fade-in" *ngIf="currentStep === 1">
    <form [formGroup]="nameAndTriggerForm">
      <div class="form-section">
        <h4 class="section-title">
          <ion-icon name="information-circle-outline" class="section-icon"></ion-icon>
          Workflow Details
        </h4>
        
        <!-- Name Field -->
        <div class="form-field" [class.error]="nameAndTriggerForm.get('name')?.invalid && nameAndTriggerForm.get('name')?.touched" 
             [class.has-value]="nameAndTriggerForm.get('name')?.value">
          <div class="input-wrapper">
            <ion-icon name="text-outline" class="field-icon"></ion-icon>
            <input 
              type="text"
              formControlName="name"
              class="custom-input"
              id="workflow-name"
              placeholder=" "
              required>
            <label for="workflow-name" class="floating-label">Workflow Name *</label>
          </div>
          <div class="error-message" *ngIf="nameAndTriggerForm.get('name')?.invalid && nameAndTriggerForm.get('name')?.touched">
            <ion-icon name="alert-circle-outline"></ion-icon>
            Workflow name is required (min 3 characters)
          </div>
        </div>

        <!-- Description Field -->
        <div class="form-field" [class.has-value]="nameAndTriggerForm.get('description')?.value">
          <div class="input-wrapper">
            <ion-icon name="document-text-outline" class="field-icon"></ion-icon>
            <textarea 
              formControlName="description"
              class="custom-textarea"
              id="workflow-description"
              rows="3"
              maxlength="200"
              placeholder=" "></textarea>
            <label for="workflow-description" class="floating-label">Description (Optional)</label>
          </div>
          <div class="char-counter">
            {{ nameAndTriggerForm.get('description')?.value?.length || 0 }}/200
          </div>
        </div>
      </div>
      
      <div class="form-section">
        <h4 class="section-title">
          <ion-icon name="git-branch-outline" class="section-icon"></ion-icon>
          Trigger Type
        </h4>
        <p class="section-description">How should this workflow be triggered?</p>
        
        <div class="trigger-options">
          <div class="trigger-card" 
               *ngFor="let type of triggerTypes"
               [class.selected]="nameAndTriggerForm.get('triggerType')?.value === type.value"
               [class.disabled]="type.disabled"
               (click)="!type.disabled && selectTriggerType(type.value)">
            <div class="trigger-card-header">
              <ion-icon [name]="type.icon" [color]="type.disabled ? 'medium' : 'primary'"></ion-icon>
              <ion-icon name="checkmark-circle" class="check-icon" *ngIf="nameAndTriggerForm.get('triggerType')?.value === type.value"></ion-icon>
            </div>
            <h3>{{ type.label }}</h3>
            <p>{{ type.description }}</p>
            <span class="coming-soon-badge" *ngIf="type.disabled">Coming Soon</span>
          </div>
        </div>
      </div>
    </form>
  </div>

  <!-- Step 2: Trigger Rules -->
  <div class="wizard-step fade-in" *ngIf="currentStep === 2">
    <form [formGroup]="triggerRulesForm">
      <!-- For Attendance-based triggers -->
      <div *ngIf="nameAndTriggerForm.get('triggerType')?.value === 'attendance'">
        
        <!-- Event Selection -->
        <div class="form-section">
          <h4 class="section-title">
            <ion-icon name="calendar-outline" class="section-icon"></ion-icon>
            Select Events
          </h4>
          <p class="section-description">Which events should this workflow monitor?</p>
          
          <div class="checkbox-field">
            <label class="custom-checkbox">
              <input type="checkbox" 
                     [checked]="triggerRulesForm.get('allEvents')?.value"
                     (change)="onAllEventsChange($event)">
              <span class="checkbox-mark"></span>
              <span class="checkbox-label">Monitor All Events</span>
            </label>
          </div>
          
          <div class="select-field" *ngIf="!triggerRulesForm.get('allEvents')?.value">
            <div class="input-wrapper">
              <ion-icon name="calendar-outline" class="field-icon"></ion-icon>
              <ion-select 
                multiple="true" 
                placeholder="Choose specific events"
                (ionChange)="onEventSelectionChange($event)"
                [value]="triggerRulesForm.get('events')?.value"
                class="custom-select">
                <ion-select-option *ngFor="let event of availableEvents" [value]="event">
                  {{ event.name }}
                </ion-select-option>
              </ion-select>
              <label class="floating-label">Select Events</label>
            </div>
          </div>
        </div>
        
        <!-- Pattern Builder -->
        <div class="form-section">
          <h4 class="section-title">
            <ion-icon name="analytics-outline" class="section-icon"></ion-icon>
            Define Trigger Pattern
          </h4>
          <p class="section-description">When should this workflow trigger?</p>
          
          <!-- Attendance Type -->
          <div class="attendance-type-selector">
            <label class="selector-label">Attendance Type</label>
            <div class="type-cards">
              <div class="type-card" 
                   *ngFor="let type of attendanceTypes"
                   [class.selected]="triggerRulesForm.get('attendanceType')?.value === type.value"
                   (click)="selectAttendanceType(type.value)">
                <ion-icon [name]="type.icon"></ion-icon>
                <span>{{ type.label }}</span>
              </div>
            </div>
          </div>
          
          <!-- Frequency -->
          <div class="frequency-selector">
            <label class="selector-label">Number of times</label>
            <div class="number-stepper">
              <button type="button" class="stepper-btn" (click)="decrementFrequency()">
                <ion-icon name="remove"></ion-icon>
              </button>
              <span class="frequency-value">{{ triggerRulesForm.get('frequency')?.value }}</span>
              <button type="button" class="stepper-btn" (click)="incrementFrequency()">
                <ion-icon name="add"></ion-icon>
              </button>
            </div>
          </div>
          
          <!-- Time Window -->
          <div class="select-field">
            <div class="input-wrapper">
              <ion-icon name="time-outline" class="field-icon"></ion-icon>
              <ion-select 
                formControlName="timeWindowDays"
                placeholder="Select time window"
                class="custom-select">
                <ion-select-option *ngFor="let window of timeWindows" [value]="window.value">
                  {{ window.label }}
                </ion-select-option>
              </ion-select>
              <label class="floating-label">Time Window</label>
            </div>
          </div>
        </div>
        
        <!-- Trigger Preview -->
        <div class="trigger-preview" *ngIf="getTriggerDescription()">
          <div class="preview-card">
            <ion-icon name="information-circle" color="primary"></ion-icon>
            <p>{{ getTriggerDescription() }}</p>
          </div>
        </div>
      </div>
      
      <!-- For Manual triggers -->
      <div *ngIf="nameAndTriggerForm.get('triggerType')?.value === 'manual'" class="manual-trigger-info">
        <div class="info-card">
          <ion-icon name="hand-left-outline" color="primary"></ion-icon>
          <h3>Manual Trigger</h3>
          <p>This workflow will be triggered manually. You'll be able to select specific members and start the workflow from the member list or workflow details page.</p>
        </div>
      </div>
    </form>
  </div>

  <!-- Step 3: Workflow Steps -->
  <div class="wizard-step fade-in" *ngIf="currentStep === 3">
    <div class="form-section">
      <h4 class="section-title">
        <ion-icon name="layers-outline" class="section-icon"></ion-icon>
        Workflow Steps
      </h4>
      <p class="section-description">Define the actions that will be taken in this workflow</p>
      
      <app-workflow-step-editor
        [steps]="workflowSteps"
        (stepsChange)="onStepsChange($event)">
      </app-workflow-step-editor>
      
      <div class="empty-steps" *ngIf="workflowSteps.length === 0">
        <div class="empty-icon-wrapper">
          <ion-icon name="layers-outline"></ion-icon>
        </div>
        <p>No steps added yet</p>
        <p class="hint">Add steps to define your workflow actions</p>
      </div>
    </div>
  </div>

  <!-- Step 4: Review & Activate -->
  <div class="wizard-step fade-in" *ngIf="currentStep === 4">
    <div class="review-section">
      <div class="review-card">
        <div class="card-header">
          <h4 class="section-title">
            <ion-icon name="checkmark-circle-outline" class="section-icon"></ion-icon>
            Review Your Workflow
          </h4>
        </div>
        
        <div class="review-item">
          <label>Name</label>
          <p>{{ nameAndTriggerForm.get('name')?.value }}</p>
        </div>
        
        <div class="review-item" *ngIf="nameAndTriggerForm.get('description')?.value">
          <label>Description</label>
          <p>{{ nameAndTriggerForm.get('description')?.value }}</p>
        </div>
        
        <div class="review-item">
          <label>Trigger Type</label>
          <p>{{ getTriggerTypeLabel() }}</p>
        </div>
        
        <div class="review-item" *ngIf="nameAndTriggerForm.get('triggerType')?.value === 'attendance'">
          <label>Trigger Pattern</label>
          <p>{{ getTriggerDescription() }}</p>
        </div>
        
        <div class="review-item">
          <label>Workflow Steps</label>
          <div class="steps-summary">
            <div class="step-summary" *ngFor="let step of workflowSteps; let i = index">
              <span class="step-number">{{ i + 1 }}</span>
              <span class="step-name">{{ step.name }}</span>
              <span class="step-type">{{ step.type }}</span>
            </div>
            <p *ngIf="workflowSteps.length === 0" class="no-steps">No steps defined</p>
          </div>
        </div>
      </div>
      
      <div class="activation-options">
        <label class="custom-checkbox">
          <input type="checkbox" formControlName="testMode" [formGroup]="reviewForm">
          <span class="checkbox-mark"></span>
          <div class="checkbox-content">
            <h3>Enable Test Mode</h3>
            <p>Run in test mode first to see how it works without actually sending messages</p>
          </div>
        </label>
      </div>
    </div>
  </div>
</ion-content>

<!-- Redesigned Footer -->
<div class="wizard-footer">
  <div class="footer-content">
    <!-- Navigation buttons for non-final steps -->
    <div class="navigation-buttons" *ngIf="currentStep < totalSteps">
      <ion-button 
        fill="clear" 
        class="back-button"
        (click)="previousStep()" 
        [disabled]="currentStep === 1">
        <ion-icon name="chevron-back" slot="start"></ion-icon>
        Back
      </ion-button>
      
      <div class="step-indicator-mini">
        <span class="current-step">{{ currentStep }}</span>
        <span class="separator">/</span>
        <span class="total-steps">{{ totalSteps }}</span>
      </div>
      
      <ion-button 
        fill="solid" 
        class="next-button"
        (click)="nextStep()" 
        [disabled]="!isStepValid">
        Continue
        <ion-icon name="chevron-forward" slot="end"></ion-icon>
      </ion-button>
    </div>
    
    <!-- Final step actions -->
    <div class="final-actions" *ngIf="currentStep === totalSteps">
      <ion-button 
        fill="clear" 
        class="back-button"
        (click)="previousStep()">
        <ion-icon name="chevron-back" slot="start"></ion-icon>
        Back
      </ion-button>
      
      <div class="action-buttons">
        <ion-button 
          fill="outline" 
          class="save-draft-button"
          (click)="saveAsDraft()">
          <ion-icon name="save-outline" slot="start"></ion-icon>
          Save as Draft
        </ion-button>
        
        <ion-button 
          fill="solid" 
          class="activate-button"
          (click)="activateWorkflow()" 
          [disabled]="workflowSteps.length === 0">
          <ion-icon name="rocket-outline" slot="start"></ion-icon>
          {{ editingWorkflow ? 'Update' : 'Activate' }} Workflow
        </ion-button>
      </div>
    </div>
  </div>
</div>