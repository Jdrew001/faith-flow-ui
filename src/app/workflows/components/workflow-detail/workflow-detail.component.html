<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-button (click)="goBack()">
        <ion-icon slot="icon-only" name="arrow-back"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-title>Workflow Details</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="showMoreActions()">
        <ion-icon slot="icon-only" name="ellipsis-vertical"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content>
  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-container">
    <div class="loading-spinner-wrapper">
      <ion-spinner name="crescent"></ion-spinner>
    </div>
    <p>Loading workflow details...</p>
  </div>

  <!-- Main Content -->
  <div *ngIf="!isLoading && workflow" class="workflow-detail-container">
    
    <!-- Compact Hero Section -->
    <div class="hero-section-compact">
      <div class="hero-top-row">
        <div class="workflow-info">
          <div class="workflow-icon-small">
            <ion-icon name="git-branch-outline"></ion-icon>
          </div>
          <div class="workflow-text">
            <h1 class="workflow-name">{{ workflow.name }}</h1>
            <p class="workflow-description" *ngIf="workflow.description">{{ workflow.description }}</p>
          </div>
        </div>
        
        <div class="status-actions-row">
          <div class="status-badge" [class]="workflow.status?.toLowerCase() || 'draft'">
            <ion-icon [name]="getStatusIcon()"></ion-icon>
            <span>{{ workflow.status || 'DRAFT' }}</span>
          </div>
          
          <div class="action-buttons">
            <button class="action-btn primary" (click)="toggleStatus()" [disabled]="workflow.status === 'DRAFT'">
              <ion-icon [name]="workflow.status === 'ACTIVE' ? 'pause-outline' : 'play-outline'"></ion-icon>
              <span class="btn-text">{{ workflow.status === 'ACTIVE' ? 'Pause' : 'Activate' }}</span>
            </button>
            <button class="action-btn secondary" (click)="editWorkflow()">
              <ion-icon name="create-outline"></ion-icon>
              <span class="btn-text">Edit</span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Compact Quick Stats -->
    <div class="quick-stats-compact">
      <div class="stat-item">
        <ion-icon name="flash-outline"></ion-icon>
        <div class="stat-content">
          <span class="stat-value">{{ workflow.stats?.totalTriggers || 0 }}</span>
          <span class="stat-label">Runs</span>
        </div>
      </div>
      
      <div class="stat-item">
        <ion-icon name="sync-circle-outline"></ion-icon>
        <div class="stat-content">
          <span class="stat-value">{{ workflow.stats?.activeInstances || 0 }}</span>
          <span class="stat-label">Active</span>
        </div>
      </div>
      
      <div class="stat-item">
        <ion-icon name="checkmark-circle-outline"></ion-icon>
        <div class="stat-content">
          <span class="stat-value">{{ workflow.stats?.successRate || 100 }}%</span>
          <span class="stat-label">Success</span>
        </div>
      </div>
      
      <div class="stat-item">
        <ion-icon name="time-outline"></ion-icon>
        <div class="stat-content">
          <span class="stat-value">{{ getLastTriggeredText() }}</span>
          <span class="stat-label">Last Run</span>
        </div>
      </div>
    </div>

    <!-- Tabs Section -->
    <div class="custom-tabs">
      <div class="tabs-header">
        <button 
          class="tab-button" 
          [class.active]="selectedTab === 'overview'"
          (click)="selectedTab = 'overview'">
          <ion-icon name="information-circle-outline"></ion-icon>
          <span>Overview</span>
        </button>
        <button 
          class="tab-button" 
          [class.active]="selectedTab === 'trigger'"
          (click)="selectedTab = 'trigger'">
          <ion-icon name="timer-outline"></ion-icon>
          <span>Trigger</span>
        </button>
        <button 
          class="tab-button" 
          [class.active]="selectedTab === 'steps'"
          (click)="selectedTab = 'steps'">
          <ion-icon name="list-outline"></ion-icon>
          <span>Steps</span>
          <span class="tab-badge" *ngIf="workflow.steps && workflow.steps.length > 0">{{ workflow.steps.length }}</span>
        </button>
        <button 
          class="tab-button" 
          [class.active]="selectedTab === 'instances'"
          (click)="selectedTab = 'instances'; loadInstances()">
          <ion-icon name="layers-outline"></ion-icon>
          <span>Instances</span>
          <span class="tab-badge" *ngIf="instances.length">{{ instances.length }}</span>
        </button>
      </div>
    </div>

    <!-- Tab Content -->
    <div class="tab-content-wrapper">
      
      <!-- Overview Tab -->
      <div class="tab-pane" *ngIf="selectedTab === 'overview'">
        <!-- Workflow Info Card -->
        <div class="info-card">
          <div class="card-header">
            <ion-icon name="information-circle" class="header-icon"></ion-icon>
            <h3>Workflow Information</h3>
          </div>
          <div class="card-content">
            <div class="info-row">
              <span class="info-label">Created</span>
              <span class="info-value">{{ workflow.created_at | date:'medium' }}</span>
            </div>
            <div class="info-row">
              <span class="info-label">Last Updated</span>
              <span class="info-value">{{ workflow.updated_at | date:'medium' }}</span>
            </div>
            <div class="info-row">
              <span class="info-label">Version</span>
              <span class="info-value">v{{ workflow.version || 1 }}</span>
            </div>
            <div class="info-row" *ngIf="workflow.created_by">
              <span class="info-label">Created By</span>
              <span class="info-value">{{ workflow.created_by }}</span>
            </div>
          </div>
        </div>

        <!-- Performance Metrics -->
        <div class="metrics-card">
          <div class="card-header">
            <ion-icon name="analytics-outline" class="header-icon"></ion-icon>
            <h3>Performance Metrics</h3>
            <div class="period-selector">
              <button 
                *ngFor="let period of ['day', 'week', 'month', 'all']"
                class="period-btn"
                [class.active]="statisticsPeriod === period"
                (click)="setPeriod($any(period))">
                {{ period | titlecase }}
              </button>
            </div>
          </div>
          <div class="card-content">
            <div class="metrics-grid">
              <div class="metric-item">
                <div class="metric-chart">
                  <svg viewBox="0 0 36 36" class="circular-chart">
                    <path class="circle-bg"
                      d="M18 2.0845
                        a 15.9155 15.9155 0 0 1 0 31.831
                        a 15.9155 15.9155 0 0 1 0 -31.831"
                    />
                    <path class="circle"
                      [style.stroke-dasharray]="getSuccessRateStroke()"
                      d="M18 2.0845
                        a 15.9155 15.9155 0 0 1 0 31.831
                        a 15.9155 15.9155 0 0 1 0 -31.831"
                    />
                  </svg>
                  <span class="metric-percentage">{{ statistics?.successRate || 0 }}%</span>
                </div>
                <span class="metric-label">Success Rate</span>
              </div>
              
              <div class="metric-stats">
                <div class="metric-stat">
                  <span class="metric-stat-value">{{ statistics?.totalTriggers || 0 }}</span>
                  <span class="metric-stat-label">Total Triggers</span>
                </div>
                <div class="metric-stat">
                  <span class="metric-stat-value">{{ statistics?.completedInstances || 0 }}</span>
                  <span class="metric-stat-label">Completed</span>
                </div>
                <div class="metric-stat">
                  <span class="metric-stat-value">{{ statistics?.failedInstances || 0 }}</span>
                  <span class="metric-stat-label">Failed</span>
                </div>
                <div class="metric-stat">
                  <span class="metric-stat-value">{{ formatDuration(statistics?.averageCompletionTime) }}</span>
                  <span class="metric-stat-label">Avg. Time</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Trigger Tab -->
      <div class="tab-pane" *ngIf="selectedTab === 'trigger'">
        <div class="trigger-card">
          <div class="trigger-header">
            <div class="trigger-type-badge" [class]="workflow.trigger?.type || 'manual'">
              <ion-icon [name]="getTriggerIcon()"></ion-icon>
              <span>{{ (workflow.triggerType || workflow.trigger?.type || 'Manual') | titlecase }} Trigger</span>
            </div>
          </div>
          
          <div class="trigger-description-box">
            <ion-icon name="information-circle" class="info-icon"></ion-icon>
            <p>{{ getTriggerDescription() }}</p>
          </div>
          
          <div class="trigger-config" *ngIf="workflow.trigger">
            <!-- Attendance Configuration -->
            <div class="config-section" *ngIf="workflow.trigger.type === 'attendance_rule' && workflow.trigger.conditions">
              <h4>Attendance Rules</h4>
              <div class="config-grid">
                <div class="config-item" *ngIf="workflow.trigger.conditions.absences_in_period">
                  <ion-icon name="alert-circle-outline"></ion-icon>
                  <div class="config-content">
                    <span class="config-label">Absences</span>
                    <span class="config-value">{{ workflow.trigger.conditions.absences_in_period.count }} in {{ workflow.trigger.conditions.absences_in_period.period_days }} days</span>
                  </div>
                </div>
                <div class="config-item" *ngIf="workflow.trigger.conditions.consecutive_absences">
                  <ion-icon name="trending-down-outline"></ion-icon>
                  <div class="config-content">
                    <span class="config-label">Consecutive Absences</span>
                    <span class="config-value">{{ workflow.trigger.conditions.consecutive_absences.count }} in a row</span>
                  </div>
                </div>
                <div class="config-item" *ngIf="workflow.trigger.conditions.no_attendance_days">
                  <ion-icon name="calendar-clear-outline"></ion-icon>
                  <div class="config-content">
                    <span class="config-label">No Attendance</span>
                    <span class="config-value">{{ workflow.trigger.conditions.no_attendance_days.days }} days</span>
                  </div>
                </div>
                <div class="config-item" *ngIf="workflow.trigger.conditions.attendance_percentage">
                  <ion-icon name="stats-chart-outline"></ion-icon>
                  <div class="config-content">
                    <span class="config-label">Attendance Rate</span>
                    <span class="config-value">Below {{ workflow.trigger.conditions.attendance_percentage.percentage }}% in {{ workflow.trigger.conditions.attendance_percentage.period_days }} days</span>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Filters -->
            <div class="config-section" *ngIf="hasAnyFilters()">
              <h4>Filters</h4>
              <div class="filters-grid">
                <div class="filter-item" *ngIf="hasTriggerFilter('memberStatus')">
                  <span class="filter-label">Member Status</span>
                  <div class="filter-values">
                    <span class="filter-chip" *ngFor="let status of getTriggerFilterValue('memberStatus')">
                      {{ status | titlecase }}
                    </span>
                  </div>
                </div>
                <div class="filter-item" *ngIf="hasTriggerFilter('ageGroups')">
                  <span class="filter-label">Age Groups</span>
                  <div class="filter-values">
                    <span class="filter-chip" *ngFor="let group of getTriggerFilterValue('ageGroups')">
                      {{ group }}
                    </span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Steps Tab -->
      <div class="tab-pane" *ngIf="selectedTab === 'steps'">
        <div class="steps-timeline" *ngIf="workflow.steps && workflow.steps.length > 0">
          <div class="step-card" *ngFor="let step of workflow.steps; let i = index; let isLast = last">
            <div class="step-connector" *ngIf="!isLast"></div>
            <div class="step-number">{{ i + 1 }}</div>
            <div class="step-content">
              <div class="step-header">
                <div class="step-icon" [class]="step.type">
                  <ion-icon [name]="getStepIcon(step.type)"></ion-icon>
                </div>
                <div class="step-title">
                  <h4>{{ step.name }}</h4>
                  <span class="step-type-badge">{{ getStepTypeLabel(step.type) }}</span>
                </div>
              </div>
              
              <div class="step-details">
                <!-- Task Details -->
                <div *ngIf="step.type === 'manual_task'" class="detail-content">
                  <div class="detail-row" *ngIf="hasStepConfigProperty(step, 'title')">
                    <ion-icon name="text-outline"></ion-icon>
                    <span>{{ getStepConfig(step, 'title') }}</span>
                  </div>
                  <div class="detail-row" *ngIf="hasStepConfigProperty(step, 'description')">
                    <ion-icon name="document-text-outline"></ion-icon>
                    <span>{{ getStepConfig(step, 'description') }}</span>
                  </div>
                  <div class="detail-row" *ngIf="hasStepConfigProperty(step, 'assignmentStrategy')">
                    <ion-icon name="person-outline"></ion-icon>
                    <span>Assigned to {{ getStepConfig(step, 'assignmentStrategy') | titlecase }}</span>
                  </div>
                  <div class="detail-row" *ngIf="hasStepConfigProperty(step, 'dueDateOffset')">
                    <ion-icon name="time-outline"></ion-icon>
                    <span>Due in {{ getStepConfig(step, 'dueDateOffset').value }} {{ getStepConfig(step, 'dueDateOffset').unit }}</span>
                  </div>
                </div>
                
                <!-- Email Details -->
                <div *ngIf="step.type === 'send_email'" class="detail-content">
                  <div class="detail-row" *ngIf="hasStepConfigProperty(step, 'subject')">
                    <ion-icon name="mail-outline"></ion-icon>
                    <span>{{ getStepConfig(step, 'subject') }}</span>
                  </div>
                  <div class="detail-row" *ngIf="hasStepConfigProperty(step, 'recipientType')">
                    <ion-icon name="person-circle-outline"></ion-icon>
                    <span>Send to {{ getStepConfig(step, 'recipientType') | titlecase }}</span>
                  </div>
                </div>
                
                <!-- SMS Details -->
                <div *ngIf="step.type === 'send_sms'" class="detail-content">
                  <div class="detail-row" *ngIf="hasStepConfigProperty(step, 'message')">
                    <ion-icon name="chatbubble-outline"></ion-icon>
                    <span>{{ getStepConfig(step, 'message') | slice:0:50 }}{{ getStepConfig(step, 'message')?.length > 50 ? '...' : '' }}</span>
                  </div>
                  <div class="detail-row" *ngIf="hasStepConfigProperty(step, 'recipientType')">
                    <ion-icon name="person-circle-outline"></ion-icon>
                    <span>Send to {{ getStepConfig(step, 'recipientType') | titlecase }}</span>
                  </div>
                </div>
                
                <!-- Wait Details -->
                <div *ngIf="step.type === 'wait'" class="detail-content">
                  <div class="detail-row" *ngIf="hasStepConfigProperty(step, 'duration')">
                    <ion-icon name="hourglass-outline"></ion-icon>
                    <span>Wait for {{ getStepConfig(step, 'duration').value }} {{ getStepConfig(step, 'duration').unit }}</span>
                  </div>
                </div>
                
                <!-- Note Details -->
                <div *ngIf="step.type === 'create_note'" class="detail-content">
                  <div class="detail-row" *ngIf="hasStepConfigProperty(step, 'content')">
                    <ion-icon name="document-text-outline"></ion-icon>
                    <span>{{ getStepConfig(step, 'content') | slice:0:100 }}{{ getStepConfig(step, 'content')?.length > 100 ? '...' : '' }}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="empty-state" *ngIf="!workflow.steps || workflow.steps.length === 0">
          <ion-icon name="list-outline"></ion-icon>
          <h3>No Steps Configured</h3>
          <p>This workflow doesn't have any steps yet.</p>
          <button class="btn-primary" (click)="editWorkflow()">
            <ion-icon name="add-outline"></ion-icon>
            Add Steps
          </button>
        </div>
      </div>

      <!-- Instances Tab -->
      <div class="tab-pane" *ngIf="selectedTab === 'instances'">
        <div class="instances-list" *ngIf="instances.length > 0">
          <div class="instance-card" *ngFor="let instance of instances" (click)="viewInstance(instance)">
            <div class="instance-header">
              <div class="instance-member">
                <div class="member-avatar">
                  {{ getInitials(instance.member_name) }}
                </div>
                <div class="member-info">
                  <h4>{{ instance.member_name }}</h4>
                  <span class="instance-date">Started {{ instance.started_at | date:'short' }}</span>
                </div>
              </div>
              <div class="instance-status" [class]="instance.status">
                {{ instance.status | titlecase }}
              </div>
            </div>
            
            <div class="instance-progress">
              <div class="progress-info">
                <span>Step {{ instance.current_step_index + 1 }} of {{ instance.total_steps || 0 }}</span>
                <span class="progress-percentage">{{ getProgressPercentage(instance) }}%</span>
              </div>
              <div class="progress-bar">
                <div class="progress-fill" [style.width.%]="getProgressPercentage(instance)"></div>
              </div>
            </div>
            
            <div class="instance-current-step">
              <ion-icon name="arrow-forward-circle-outline"></ion-icon>
              <span>{{ getCurrentStepName(instance) }}</span>
            </div>
          </div>
        </div>
        
        <div class="empty-state" *ngIf="instances.length === 0">
          <ion-icon name="layers-outline"></ion-icon>
          <h3>No Active Instances</h3>
          <p>There are no running instances of this workflow.</p>
        </div>
      </div>
    </div>
  </div>
</ion-content>

<!-- Floating Action Button -->
<ion-fab vertical="bottom" horizontal="end" slot="fixed" *ngIf="!isLoading && workflow">
  <ion-fab-button>
    <ion-icon name="add"></ion-icon>
  </ion-fab-button>
  <ion-fab-list side="top">
    <ion-fab-button (click)="testWorkflow()" color="secondary">
      <ion-icon name="flask-outline"></ion-icon>
    </ion-fab-button>
    <ion-fab-button (click)="duplicateWorkflow()" color="tertiary">
      <ion-icon name="copy-outline"></ion-icon>
    </ion-fab-button>
    <ion-fab-button (click)="startManualRun()" color="success" *ngIf="workflow.trigger?.type === 'manual'">
      <ion-icon name="play-outline"></ion-icon>
    </ion-fab-button>
  </ion-fab-list>
</ion-fab>