<!-- Existing Steps List -->
<div class="steps-list" *ngIf="steps.length > 0">
  <ion-reorder-group (ionItemReorder)="reorderSteps($event)" disabled="false">
    <ion-item-sliding *ngFor="let step of steps; let i = index">
      <ion-item class="step-item">
        <ion-reorder slot="start">
          <ion-icon name="reorder-three-outline"></ion-icon>
        </ion-reorder>
        
        <div class="step-content">
          <div class="step-header">
            <span class="step-number">{{ i + 1 }}</span>
            <ion-icon [name]="getStepIcon(step.type)" class="step-icon"></ion-icon>
            <span class="step-name">{{ step.name }}</span>
            <ion-badge class="step-type">{{ step.type }}</ion-badge>
          </div>
          <div class="step-description">
            {{ getStepDescription(step) }}
          </div>
        </div>
        
        <ion-button fill="clear" slot="end" (click)="removeStep(i)">
          <ion-icon name="trash-outline" color="danger"></ion-icon>
        </ion-button>
      </ion-item>
      
      <ion-item-options side="end">
        <ion-item-option color="danger" (click)="removeStep(i)">
          <ion-icon name="trash-outline"></ion-icon>
          Delete
        </ion-item-option>
      </ion-item-options>
    </ion-item-sliding>
  </ion-reorder-group>
</div>

<!-- Add Step Button -->
<div class="add-step-buttons" *ngIf="!showEditor">
  <ion-button expand="block" fill="outline" (click)="openStepEditor('task')">
    <ion-icon slot="start" name="add-circle-outline"></ion-icon>
    Add Step
  </ion-button>
  
  <div class="quick-add-buttons">
    <ion-chip *ngFor="let type of stepTypes" (click)="openStepEditor(type.type)">
      <ion-icon [name]="type.icon"></ion-icon>
      <ion-label>{{ type.label }}</ion-label>
    </ion-chip>
  </div>
</div>

<!-- Step Editor -->
<div class="step-editor" *ngIf="showEditor">
  <div class="editor-header">
    <h4>{{ selectedStepType ? getStepTypeLabel(selectedStepType) : 'Add Step' }}</h4>
    <ion-button fill="clear" size="small" (click)="cancelEditor()">
      <ion-icon slot="icon-only" name="close"></ion-icon>
    </ion-button>
  </div>
  
  <form [formGroup]="stepForm" class="step-form">
    <!-- Common Fields -->
    <div class="form-field" [class.has-value]="stepForm.get('name')?.value">
      <div class="input-wrapper">
        <ion-icon name="text-outline" class="field-icon"></ion-icon>
        <input 
          type="text"
          class="custom-input"
          formControlName="name"
          placeholder=" "
          required>
        <label class="floating-label">Step Name *</label>
      </div>
    </div>
    
    <!-- Task Configuration -->
    <div *ngIf="selectedStepType === 'task'" class="step-config">
      <div class="form-field" [class.has-value]="stepForm.get('taskTitle')?.value">
        <div class="input-wrapper">
          <ion-icon name="clipboard-outline" class="field-icon"></ion-icon>
          <input 
            type="text"
            class="custom-input"
            formControlName="taskTitle"
            placeholder=" "
            required>
          <label class="floating-label">Task Title *</label>
        </div>
      </div>
      
      <div class="form-field" [class.has-value]="stepForm.get('taskDescription')?.value">
        <div class="input-wrapper">
          <ion-icon name="document-text-outline" class="field-icon"></ion-icon>
          <textarea 
            class="custom-textarea"
            formControlName="taskDescription"
            rows="3"
            placeholder=" "
            required></textarea>
          <label class="floating-label">Instructions *</label>
        </div>
      </div>
      
      <div class="select-field">
        <div class="input-wrapper">
          <ion-icon name="people-outline" class="field-icon"></ion-icon>
          <ion-select 
            formControlName="assignmentStrategy" 
            interface="popover"
            class="custom-select">
            <ion-select-option *ngFor="let strategy of assignmentStrategies" [value]="strategy.value">
              {{ strategy.label }}
            </ion-select-option>
          </ion-select>
          <label class="floating-label">Assignment Strategy</label>
        </div>
      </div>
      
      <div class="duration-selector">
        <label class="section-label">Due Date</label>
        <div class="duration-inputs">
          <div class="form-field inline-field" [class.has-value]="stepForm.get('dueDateValue')?.value">
            <div class="input-wrapper">
              <ion-icon name="calendar-outline" class="field-icon"></ion-icon>
              <input 
                type="number"
                class="custom-input"
                formControlName="dueDateValue"
                min="1"
                placeholder="24">
              <label class="floating-label">Value</label>
            </div>
          </div>
          <div class="select-field inline-field">
            <div class="input-wrapper">
              <ion-select 
                formControlName="dueDateUnit" 
                interface="popover"
                class="custom-select">
                <ion-select-option *ngFor="let unit of timeUnits" [value]="unit.value">
                  {{ unit.label }}
                </ion-select-option>
              </ion-select>
              <label class="floating-label">Unit</label>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- SMS Configuration -->
    <div *ngIf="selectedStepType === 'sms'" class="step-config">
      <div class="form-field" [class.has-value]="stepForm.get('smsMessage')?.value">
        <div class="input-wrapper">
          <ion-icon name="chatbubble-outline" class="field-icon"></ion-icon>
          <textarea 
            class="custom-textarea"
            formControlName="smsMessage"
            rows="3"
            maxlength="160"
            placeholder=" "
            required></textarea>
          <label class="floating-label">Message *</label>
        </div>
        <div class="char-counter">{{ getRemainingChars() }} characters remaining</div>
      </div>
      
      <div class="select-field">
        <div class="input-wrapper">
          <ion-icon name="send-outline" class="field-icon"></ion-icon>
          <ion-select 
            formControlName="smsRecipientType" 
            interface="popover"
            class="custom-select">
            <ion-select-option *ngFor="let type of recipientTypes" [value]="type.value">
              {{ type.label }}
            </ion-select-option>
          </ion-select>
          <label class="floating-label">Send To</label>
        </div>
      </div>
      
      <div class="form-field" *ngIf="stepForm.get('smsRecipientType')?.value === 'custom'" 
           [class.has-value]="stepForm.get('smsCustomNumber')?.value">
        <div class="input-wrapper">
          <ion-icon name="call-outline" class="field-icon"></ion-icon>
          <input 
            type="tel"
            class="custom-input"
            formControlName="smsCustomNumber"
            placeholder=" ">
          <label class="floating-label">Phone Number</label>
        </div>
      </div>
      
      <div class="form-field" [class.has-value]="stepForm.get('smsDelayHours')?.value || stepForm.get('smsDelayHours')?.value === 0">
        <div class="input-wrapper">
          <ion-icon name="time-outline" class="field-icon"></ion-icon>
          <input 
            type="number"
            class="custom-input"
            formControlName="smsDelayHours"
            min="0"
            placeholder="0">
          <label class="floating-label">Delay (hours)</label>
        </div>
      </div>
    </div>
    
    <!-- Email Configuration -->
    <div *ngIf="selectedStepType === 'email'" class="step-config">
      <div class="form-field" [class.has-value]="stepForm.get('emailSubject')?.value">
        <div class="input-wrapper">
          <ion-icon name="mail-outline" class="field-icon"></ion-icon>
          <input 
            type="text"
            class="custom-input"
            formControlName="emailSubject"
            placeholder=" "
            required>
          <label class="floating-label">Subject *</label>
        </div>
      </div>
      
      <div class="form-field" [class.has-value]="stepForm.get('emailBody')?.value">
        <div class="input-wrapper">
          <ion-icon name="document-text-outline" class="field-icon"></ion-icon>
          <textarea 
            class="custom-textarea"
            formControlName="emailBody"
            rows="5"
            placeholder=" "
            required></textarea>
          <label class="floating-label">Message Body *</label>
        </div>
      </div>
      
      <div class="select-field">
        <div class="input-wrapper">
          <ion-icon name="send-outline" class="field-icon"></ion-icon>
          <ion-select 
            formControlName="emailRecipientType" 
            interface="popover"
            class="custom-select">
            <ion-select-option *ngFor="let type of recipientTypes" [value]="type.value">
              {{ type.label }}
            </ion-select-option>
          </ion-select>
          <label class="floating-label">Send To</label>
        </div>
      </div>
      
      <div class="form-field" *ngIf="stepForm.get('emailRecipientType')?.value === 'custom'" 
           [class.has-value]="stepForm.get('emailCustomEmail')?.value">
        <div class="input-wrapper">
          <ion-icon name="at-outline" class="field-icon"></ion-icon>
          <input 
            type="email"
            class="custom-input"
            formControlName="emailCustomEmail"
            placeholder=" ">
          <label class="floating-label">Email Address</label>
        </div>
      </div>
      
      <div class="form-field" [class.has-value]="stepForm.get('emailDelayHours')?.value || stepForm.get('emailDelayHours')?.value === 0">
        <div class="input-wrapper">
          <ion-icon name="time-outline" class="field-icon"></ion-icon>
          <input 
            type="number"
            class="custom-input"
            formControlName="emailDelayHours"
            min="0"
            placeholder="0">
          <label class="floating-label">Delay (hours)</label>
        </div>
      </div>
    </div>
    
    <!-- Wait Configuration -->
    <div *ngIf="selectedStepType === 'wait'" class="step-config">
      <div class="duration-selector">
        <label class="section-label">Wait Duration</label>
        <div class="duration-inputs">
          <div class="form-field inline-field" [class.has-value]="stepForm.get('waitValue')?.value">
            <div class="input-wrapper">
              <ion-icon name="timer-outline" class="field-icon"></ion-icon>
              <input 
                type="number"
                class="custom-input"
                formControlName="waitValue"
                min="1"
                placeholder="1">
              <label class="floating-label">Value</label>
            </div>
          </div>
          <div class="select-field inline-field">
            <div class="input-wrapper">
              <ion-select 
                formControlName="waitUnit" 
                interface="popover"
                class="custom-select">
                <ion-select-option *ngFor="let unit of timeUnits" [value]="unit.value">
                  {{ unit.label }}
                </ion-select-option>
              </ion-select>
              <label class="floating-label">Unit</label>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Note Configuration -->
    <div *ngIf="selectedStepType === 'note'" class="step-config">
      <div class="form-field" [class.has-value]="stepForm.get('noteContent')?.value">
        <div class="input-wrapper">
          <ion-icon name="document-text-outline" class="field-icon"></ion-icon>
          <textarea 
            class="custom-textarea"
            formControlName="noteContent"
            rows="4"
            placeholder=" "
            required></textarea>
          <label class="floating-label">Note Content *</label>
        </div>
      </div>
      
      <div class="checkbox-field">
        <label class="custom-checkbox">
          <input type="checkbox" formControlName="noteAttachToMember">
          <span class="checkbox-mark"></span>
          <span class="checkbox-label">Attach to member profile</span>
        </label>
      </div>
    </div>
  </form>
  
  <div class="editor-actions">
    <ion-button fill="clear" (click)="cancelEditor()">Cancel</ion-button>
    <ion-button fill="solid" (click)="saveStep()" [disabled]="!stepForm.valid">
      Add Step
    </ion-button>
  </div>
</div>