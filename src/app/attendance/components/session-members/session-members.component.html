<div class="session-members-page" 
     [class.selection-mode]="isSelectionMode">
  <ion-header>
    <ion-toolbar class="main-toolbar">
      <ion-buttons slot="start">
        <ion-button (click)="dismiss()" fill="clear">
          <ion-icon name="arrow-back" slot="icon-only"></ion-icon>
        </ion-button>
      </ion-buttons>
      <ion-title>{{ session ? session.title : 'Session' }}</ion-title>
      <ion-buttons slot="end">
        <ion-button (click)="toggleViewMode()" fill="clear">
          <ion-icon [name]="viewMode === 'grid' ? 'list-outline' : 'grid-outline'" slot="icon-only"></ion-icon>
        </ion-button>
      </ion-buttons>
    </ion-toolbar>
    
    <!-- Selection Mode Header -->
    <ion-toolbar *ngIf="isSelectionMode" class="selection-toolbar">
      <ion-title>{{ selectedCount }} Selected</ion-title>
      <ion-buttons slot="start">
        <ion-button (click)="exitSelectionMode()" fill="clear">
          <ion-icon name="arrow-back" slot="icon-only"></ion-icon>
        </ion-button>
      </ion-buttons>
      <ion-buttons slot="end">
        <ion-button (click)="selectAllVisible()" fill="clear" size="small">
          <ion-icon name="checkmark-done-outline" slot="icon-only"></ion-icon>
        </ion-button>
        <ion-button (click)="deselectAll()" fill="clear" size="small">
          <ion-icon name="close-outline" slot="icon-only"></ion-icon>
        </ion-button>
      </ion-buttons>
    </ion-toolbar>
    
    <!-- Compact Stats Bar -->
    <div class="stats-bar">
      <div class="stat-item present" (click)="onFilterChange('present')">
        <span class="stat-value">{{ presentCount }}</span>
        <span class="stat-label">Present</span>
      </div>
      <div class="stat-item absent" (click)="onFilterChange('absent')">
        <span class="stat-value">{{ absentCount }}</span>
        <span class="stat-label">Absent</span>
      </div>
      <div class="stat-item unmarked" (click)="onFilterChange('unmarked')">
        <span class="stat-value">{{ unmarkedCount }}</span>
        <span class="stat-label">Unmarked</span>
      </div>
      <div class="stat-item rate">
        <span class="stat-value">{{ attendanceRate }}%</span>
        <span class="stat-label">Rate</span>
      </div>
    </div>
  </ion-header>

  <ion-content class="members-content" 
               [class.has-sticky-actions]="isSelectionMode && selectedCount > 0" 
               [scrollY]="true" 
               [scrollEvents]="true">

    <!-- Enhanced Info Bar -->
    <div class="info-bar" *ngIf="!isLoading && filteredMembers.length > 0">
      <div class="info-content">
        <div class="member-count">
          <span class="count-value">{{ filteredMembers.length }}</span>
          <span class="count-label">{{ selectedFilter === 'all' ? 'Total Members' : (selectedFilter | titlecase) }}</span>
        </div>
        <div class="last-updated" *ngIf="lastUpdated">
          <ion-icon name="sync-outline"></ion-icon>
          <span>Updated {{ getTimeSinceUpdate() }}</span>
        </div>
      </div>
    </div>

    <!-- Enhanced Search & Filter Bar -->
    <div class="search-filter-section">
      <div class="search-container">
        <ion-searchbar 
          [formControl]="searchControl"
          placeholder="Search by name..."
          debounce="300"
          showClearButton="focus"
          class="enhanced-searchbar">
        </ion-searchbar>
        <button class="filter-toggle" (click)="toggleFilterView()" [class.active]="showFilters">
          <ion-icon name="funnel-outline"></ion-icon>
          <span>Filters</span>
          <ion-badge *ngIf="activeFilterCount > 0" color="primary">{{ activeFilterCount }}</ion-badge>
        </button>
      </div>

      <div class="filter-chips" *ngIf="showFilters">
        <ion-chip 
          [color]="selectedFilter === 'all' ? 'primary' : 'medium'"
          [outline]="selectedFilter !== 'all'"
          (click)="onFilterChange('all')">
          <ion-icon name="people-outline"></ion-icon>
          <ion-label>All ({{ members.length }})</ion-label>
        </ion-chip>
        
        <ion-chip 
          [color]="selectedFilter === 'present' ? 'success' : 'medium'"
          [outline]="selectedFilter !== 'present'"
          (click)="onFilterChange('present')">
          <ion-icon name="checkmark-circle-outline"></ion-icon>
          <ion-label>Present ({{ presentCount }})</ion-label>
        </ion-chip>
        
        <ion-chip 
          [color]="selectedFilter === 'absent' ? 'danger' : 'medium'"
          [outline]="selectedFilter !== 'absent'"
          (click)="onFilterChange('absent')">
          <ion-icon name="close-circle-outline"></ion-icon>
          <ion-label>Absent ({{ absentCount }})</ion-label>
        </ion-chip>
        
        <ion-chip 
          [color]="selectedFilter === 'unmarked' ? 'tertiary' : 'medium'"
          [outline]="selectedFilter !== 'unmarked'"
          (click)="onFilterChange('unmarked')">
          <ion-icon name="help-circle-outline"></ion-icon>
          <ion-label>Unmarked ({{ unmarkedCount }})</ion-label>
        </ion-chip>
      </div>
    </div>

    <!-- Loading State -->
    <div *ngIf="isLoading" class="loading-state">
      <ion-spinner name="circular"></ion-spinner>
      <p>Loading members...</p>
    </div>

    <!-- Enhanced Members List -->
    <div *ngIf="!isLoading" class="members-container">
      <!-- Grid View -->
      <div class="members-grid" *ngIf="viewMode === 'grid'">
        <div 
          *ngFor="let member of filteredMembers; trackBy: trackByMemberId"
          class="member-card"
          [attr.data-member-id]="member.personId"
          [class.selected]="member.selected"
          [class.selection-mode]="isSelectionMode"
          (click)="handleMemberClick(member, $event)"
          (touchstart)="onTouchStart(member, $event)"
          (touchend)="onTouchEnd($event)"
          (touchmove)="onTouchMove($event)">
          
          <!-- Card Selection Overlay -->
          <div class="card-selection-overlay" *ngIf="isSelectionMode">
            <ion-checkbox 
              [checked]="member.selected"
              (ionChange)="toggleMemberSelection(member, $event)"
              color="primary">
            </ion-checkbox>
          </div>
          
          <!-- Card Content -->
          <div class="card-avatar-section">
            <div class="member-avatar" [class]="member.status.toLowerCase()">
              <div *ngIf="!member.avatar" class="avatar-initials">
                {{ getInitials(member.personName) }}
              </div>
              <img *ngIf="member.avatar" [src]="member.avatar" [alt]="member.personName">
            </div>
          </div>
          
          <div class="card-info">
            <h3 class="member-name">{{ member.personName }}</h3>
            <div class="member-status-text">
              <span [class]="'status-label ' + member.status.toLowerCase()">
                {{ member.status }}
              </span>
              <span *ngIf="member.timestamp" class="timestamp">
                {{ member.timestamp | date:'shortTime' }}
              </span>
            </div>
          </div>
          
          <!-- Quick Actions -->
          <div class="card-quick-actions" *ngIf="!isSelectionMode">
            <button class="action-button present" 
                    [class.active]="member.status === 'Present'"
                    (click)="updateMemberStatus(member, 'Present', $event)">
              <ion-icon name="checkmark"></ion-icon>
            </button>
            <button class="action-button absent" 
                    [class.active]="member.status === 'Absent'"
                    (click)="updateMemberStatus(member, 'Absent', $event)">
              <ion-icon name="close-outline"></ion-icon>
            </button>
            <button class="action-button unmarked" 
                    [class.active]="member.status === 'Unmarked'"
                    (click)="updateMemberStatus(member, 'Unmarked', $event)">
              <ion-icon name="help-circle-outline"></ion-icon>
            </button>
          </div>
        </div>
      </div>
      
      <!-- List View -->
      <div class="members-list" *ngIf="viewMode === 'list'">
        <div 
          *ngFor="let member of filteredMembers; trackBy: trackByMemberId"
          class="member-list-item"
          [attr.data-member-id]="member.personId"
          [class.selected]="member.selected"
          [class.selection-mode]="isSelectionMode"
          (click)="handleMemberClick(member, $event)"
          (touchstart)="onTouchStart(member, $event)"
          (touchend)="onTouchEnd($event)"
          (touchmove)="onTouchMove($event)">
          
          <!-- Selection Checkbox -->
          <div class="list-selection" *ngIf="isSelectionMode">
            <ion-checkbox 
              [checked]="member.selected"
              (ionChange)="toggleMemberSelection(member, $event)"
              color="primary">
            </ion-checkbox>
          </div>
          
          <div class="list-avatar">
            <div *ngIf="!member.avatar" class="avatar-initials" [class]="member.status.toLowerCase()">
              {{ getInitials(member.personName) }}
            </div>
            <img *ngIf="member.avatar" [src]="member.avatar" [alt]="member.personName">
          </div>
          
          <div class="list-content">
            <div class="list-header">
              <h4 class="member-name">{{ member.personName }}</h4>
              <div class="status-indicator" [class]="member.status.toLowerCase()">
                <ion-icon [name]="getStatusIcon(member.status)"></ion-icon>
                <span>{{ member.status }}</span>
              </div>
            </div>
            <div class="list-meta" *ngIf="member.timestamp">
              <ion-icon name="time-outline"></ion-icon>
              <span>Marked at {{ member.timestamp | date:'shortTime' }}</span>
            </div>
          </div>
          
          <div class="list-actions" *ngIf="!isSelectionMode">
            <button class="quick-toggle" 
                    [class]="member.status.toLowerCase()"
                    (click)="quickStatusToggle(member, $event)">
              <ion-icon [name]="getStatusIcon(member.status)"></ion-icon>
            </button>
          </div>
        </div>
      </div>

      <!-- Empty State -->
      <div *ngIf="filteredMembers.length === 0" class="empty-members">
        <ion-icon name="people-outline" class="empty-icon"></ion-icon>
        <h3>No Members Found</h3>
        <p>No members match your current search or filter.</p>
      </div>
      
      <!-- Bottom padding to ensure last item is accessible -->
      <div class="bottom-padding"></div>
    </div>
  </ion-content>

  <!-- Enhanced Floating Action Bar -->
  <div class="floating-action-bar" *ngIf="isSelectionMode && selectedCount > 0">
    <div class="selection-info">
      <div class="selection-count">
        <span class="count">{{ selectedCount }}</span>
        <span class="label">Selected</span>
      </div>
      <button class="clear-selection" (click)="exitSelectionMode()">
        <ion-icon name="close"></ion-icon>
      </button>
    </div>
    
    <div class="action-buttons">
      <button class="fab-action present" (click)="markSelectedAs('Present')">
        <ion-icon name="checkmark-circle"></ion-icon>
        <span>Present</span>
      </button>
      
      <button class="fab-action absent" (click)="markSelectedAs('Absent')">
        <ion-icon name="remove-circle"></ion-icon>
        <span>Absent</span>
      </button>
      
      <button class="fab-action unmarked" (click)="markSelectedAs('Unmarked')">
        <ion-icon name="help-circle-outline"></ion-icon>
        <span>Unmarked</span>
      </button>
    </div>
  </div>
  
  <!-- Success Animation Overlay -->
  <div class="success-overlay" *ngIf="showSuccessAnimation">
    <div class="success-content">
      <ion-icon name="checkmark-circle" class="success-icon"></ion-icon>
      <h2>Attendance Updated!</h2>
      <p>{{ successMessage }}</p>
    </div>
  </div>
</div>
