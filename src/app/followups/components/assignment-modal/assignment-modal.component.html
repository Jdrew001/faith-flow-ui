<ion-modal [isOpen]="isOpen" (willDismiss)="closeModal()">
  <ng-template>
    <ion-header class="modal-header">
      <ion-toolbar>
        <ion-title>Assign Follow-up</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="closeModal()" class="close-button">
            <ion-icon name="close"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    
    <ion-content class="modal-content">
      <div class="content-wrapper" *ngIf="followupItem">
        <!-- Follow-up Info Header -->
        <div class="followup-header">
          <div class="followup-info">
            <h3>{{ followupItem.title }}</h3>
            <p class="person-name">
              <ion-icon name="person-outline"></ion-icon>
              {{ followupItem.personName }}
            </p>
            <p class="followup-type">
              <ion-icon [name]="getTypeIcon(followupItem.type)"></ion-icon>
              {{ followupItem.type }}
            </p>
          </div>
          <ion-chip [color]="getPriorityColor(followupItem.priority)" class="priority-chip">
            {{ followupItem.priority | titlecase }}
          </ion-chip>
        </div>

        <!-- Assignment Form -->
        <form [formGroup]="assignmentForm" class="form-section">
          <h4 class="section-title">
            <ion-icon name="settings-outline" class="section-icon"></ion-icon>
            Assignment Details
          </h4>
          
          <!-- Assignee Selection -->
          <div class="select-field">
            <div class="select-header">
              <ion-icon name="person-add-outline" class="field-icon"></ion-icon>
              <label class="select-label">Assign To *</label>
            </div>
            <div class="assignee-grid">
              <div 
                *ngFor="let assignee of getAvailableAssignees()" 
                class="assignee-card" 
                [class.selected]="assignedToControl?.value === assignee.value"
                (click)="selectAssignee(assignee.value)">
                <div class="assignee-avatar" [attr.data-color]="assignee.color">
                  {{ assignee.avatar }}
                </div>
                <div class="assignee-info">
                  <div class="assignee-name">{{ assignee.label }}</div>
                  <div class="assignee-role">{{ assignee.role }}</div>
                </div>
                <ion-icon 
                  name="checkmark-circle" 
                  class="selection-icon"
                  *ngIf="assignedToControl?.value === assignee.value">
                </ion-icon>
              </div>
              
              <!-- Unassigned Option -->
              <div 
                class="assignee-card unassigned-card" 
                [class.selected]="assignedToControl?.value === ''"
                (click)="selectAssignee('')">
                <div class="assignee-avatar unassigned">
                  <ion-icon name="person-outline"></ion-icon>
                </div>
                <div class="assignee-info">
                  <div class="assignee-name">Unassigned</div>
                  <div class="assignee-role">No assignee</div>
                </div>
                <ion-icon 
                  name="checkmark-circle" 
                  class="selection-icon"
                  *ngIf="assignedToControl?.value === ''">
                </ion-icon>
              </div>
            </div>
            <div class="error-message" *ngIf="assignedToControl?.invalid && assignedToControl?.touched">
              Please select an assignee
            </div>
          </div>

          <!-- Priority Update -->
          <div class="select-field">
            <div class="select-header">
              <ion-icon name="flag-outline" class="field-icon"></ion-icon>
              <label class="select-label">Priority Level</label>
            </div>
            <ion-select 
              formControlName="priority" 
              interface="popover"
              class="custom-select">
              <ion-select-option value="high">High Priority</ion-select-option>
              <ion-select-option value="medium">Medium Priority</ion-select-option>
              <ion-select-option value="low">Low Priority</ion-select-option>
            </ion-select>
          </div>

          <!-- Due Date -->
          <div class="datetime-section">
            <div class="datetime-header">
              <ion-icon name="calendar-outline" class="field-icon"></ion-icon>
              <label class="datetime-label">Due Date</label>
            </div>
            <div class="datetime-wrapper">
              <ion-datetime 
                formControlName="dueDate"
                presentation="date"
                [min]="getMinDate()"
                class="full-width-datetime">
              </ion-datetime>
            </div>
          </div>

          <!-- Assignment Notes -->
          <div class="form-field" [class.has-value]="notesControl?.value">
            <div class="input-wrapper">
              <ion-icon name="document-text-outline" class="field-icon"></ion-icon>
              <textarea 
                class="custom-textarea"
                formControlName="notes"
                rows="3"
                placeholder=" ">
              </textarea>
              <label class="floating-label">Assignment Notes</label>
            </div>
          </div>
        </form>

        <!-- Action Buttons -->
        <div class="modal-actions">
          <ion-button 
            expand="block" 
            fill="clear" 
            (click)="closeModal()"
            class="cancel-button">
            Cancel
          </ion-button>
          <ion-button 
            expand="block" 
            (click)="saveAssignment()"
            [disabled]="!assignmentForm.valid"
            class="save-button">
            <ion-icon name="checkmark-outline" slot="start"></ion-icon>
            Assign Follow-up
          </ion-button>
        </div>
      </div>
    </ion-content>
  </ng-template>
</ion-modal>