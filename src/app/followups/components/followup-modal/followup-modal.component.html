<ion-header class="modal-header">
  <ion-toolbar>
    <ion-title>{{ isEditing ? 'Edit' : 'Create' }} Follow-up</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="closeModal()" class="close-button">
        <ion-icon name="close"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>
<ion-content class="modal-content">
  <form [formGroup]="followupForm" (ngSubmit)="saveFollowup()">
    <div class="form-section">
      <!-- Member Selection Field -->
      <div class="member-selection-field">
        <app-member-search
          formControlName="selectedMember"
          placeholder="Search for a member..."
          [required]="true"
        ></app-member-search>
        <div class="error-message" *ngIf="selectedMemberControl?.invalid && selectedMemberControl?.touched">
          Please select a member
        </div>
      </div>

      <!-- Title Field -->
      <div class="form-field" [class.has-value]="titleControl?.value">
        <div class="input-wrapper">
          <ion-icon name="create-outline" class="field-icon"></ion-icon>
          <input 
            type="text"
            class="custom-input"
            formControlName="title"
            required>
          <label class="floating-label">Title *</label>
        </div>
        <div class="error-message" *ngIf="titleControl?.invalid && titleControl?.touched">
          Title is required
        </div>
      </div>

      <!-- Description Field -->
      <div class="form-field" [class.has-value]="descriptionControl?.value">
        <div class="input-wrapper">
          <ion-icon name="document-text-outline" class="field-icon"></ion-icon>
          <textarea 
            class="custom-textarea"
            formControlName="description"
            rows="3">
          </textarea>
          <label class="floating-label">Description</label>
        </div>
      </div>

      <!-- Type Select -->
      <div class="select-field">
        <div class="select-header">
          <ion-icon name="pricetag-outline" class="field-icon"></ion-icon>
          <label class="select-label">Type *</label>
        </div>
        <ion-select 
          formControlName="type"
          interface="popover"
          class="custom-select">
          <ion-select-option *ngFor="let type of followupTypes" [value]="type.value">
            {{ type.label }}
          </ion-select-option>
        </ion-select>
        <div class="error-message" *ngIf="typeControl?.invalid && typeControl?.touched">
          Type is required
        </div>
      </div>

      <!-- Priority Select -->
      <div class="select-field">
        <div class="select-header">
          <ion-icon name="flag-outline" class="field-icon"></ion-icon>
          <label class="select-label">Priority</label>
        </div>
        <ion-select 
          formControlName="priority"
          interface="popover"
          class="custom-select">
          <ion-select-option *ngFor="let priority of priorities" [value]="priority.value">
            {{ priority.label }}
          </ion-select-option>
        </ion-select>
      </div>

      <!-- Assign To Select -->
      <div class="select-field">
        <div class="select-header">
          <ion-icon name="person-add-outline" class="field-icon"></ion-icon>
          <label class="select-label">Assign To</label>
        </div>
        <ion-select 
          formControlName="assignedTo"
          interface="popover"
          class="custom-select">
          <ion-select-option value="">Unassigned</ion-select-option>
          <ion-select-option *ngFor="let assignee of getAssigneesList()" [value]="assignee.value">
            {{ assignee.label }}
          </ion-select-option>
        </ion-select>
      </div>

      <!-- Status Select (only show when editing) -->
      <div class="select-field" *ngIf="isEditing">
        <div class="select-header">
          <ion-icon name="stats-chart-outline" class="field-icon"></ion-icon>
          <label class="select-label">Status</label>
        </div>
        <ion-select 
          formControlName="status"
          interface="popover"
          class="custom-select">
          <ion-select-option *ngFor="let status of statuses" [value]="status.value">
            {{ status.label }}
          </ion-select-option>
        </ion-select>
      </div>

      <!-- Due Date -->
      <div class="datetime-section">
        <app-enhanced-date-picker
          formControlName="dueDate"
          label="Due Date"
          placeholder="Select due date"
          [minDate]="getMinDate()">
        </app-enhanced-date-picker>
      </div>

      <!-- Notes Field -->
      <div class="form-field" [class.has-value]="notesControl?.value">
        <div class="input-wrapper">
          <ion-icon name="clipboard-outline" class="field-icon"></ion-icon>
          <textarea 
            class="custom-textarea"
            formControlName="notes"
            rows="4"
            placeholder="Additional notes or instructions...">
          </textarea>
          <label class="floating-label">Notes</label>
        </div>
      </div>

      <!-- Contact Information Section -->
      <div class="contact-section" formGroupName="contactInfo">
        <h4>
          <ion-icon name="call-outline" class="section-icon"></ion-icon>
          Contact Information
        </h4>
        
        <!-- Phone Field -->
        <div class="form-field" [class.has-value]="phoneControl?.value" [class.readonly-field]="isContactInfoFromMember">
          <div class="input-wrapper">
            <ion-icon name="call-outline" class="field-icon"></ion-icon>
            <input 
              type="tel"
              class="custom-input"
              formControlName="phone"
              [readonly]="isContactInfoFromMember">
            <label class="floating-label">Phone</label>
            <ion-icon 
              name="lock-closed-outline" 
              class="lock-icon" 
              *ngIf="isContactInfoFromMember"
              title="This value comes from the selected member">
            </ion-icon>
          </div>
        </div>

        <!-- Email Field -->
        <div class="form-field" [class.has-value]="emailControl?.value" [class.readonly-field]="isContactInfoFromMember">
          <div class="input-wrapper">
            <ion-icon name="mail-outline" class="field-icon"></ion-icon>
            <input 
              type="email"
              class="custom-input"
              formControlName="email"
              [readonly]="isContactInfoFromMember">
            <label class="floating-label">Email</label>
            <ion-icon 
              name="lock-closed-outline" 
              class="lock-icon" 
              *ngIf="isContactInfoFromMember"
              title="This value comes from the selected member">
            </ion-icon>
          </div>
          <div class="error-message" *ngIf="emailControl?.invalid && emailControl?.touched && !isContactInfoFromMember">
            Please enter a valid email address
          </div>
        </div>
      </div>
    </div>

    <div class="modal-actions">
      <ion-button expand="block" type="submit" [disabled]="!isFormValid()">
        <ion-icon name="save-outline" slot="start"></ion-icon>
        {{ isEditing ? 'Update' : 'Create' }} Follow-up
      </ion-button>
    </div>
  </form>
</ion-content>